function doGet(e) {
  var sheet = SpreadsheetApp.openById("1TKl9Zv5HLesK8vLozcb0613mZ2EA093zkz5JnM7UmXY"); 
  var sheet1 = sheet.getSheetByName("DANHSACH"); 
  var sheet2 = sheet.getSheetByName("DIEMDANH");

  var action = e.parameter.action;
  var response = {}; // Tạo object JSON phản hồi

  if (action == "register") {
    var rfid = e.parameter.rfid;
    var name = e.parameter.name;

    var data = sheet1.getDataRange().getValues();
    for (var i = 1; i < data.length; i++) {
      if (data[i][0] == rfid) {
        response.status = "error";
        response.message = "Thẻ đã tồn tại";
        return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
      }
    }

    sheet1.appendRow([rfid, name]);
    response.status = "success";
    response.message = "Đăng ký thành công";
    return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);

  } else if (action == "checkin") {
    var rfid = e.parameter.rfid;
    var date = new Date();
    var time = Utilities.formatDate(date, Session.getScriptTimeZone(), "HH:mm:ss");
    var today = Utilities.formatDate(date, Session.getScriptTimeZone(), "yyyy-MM-dd");

    var studentName = "";
    var data = sheet1.getDataRange().getValues();
    for (var i = 1; i < data.length; i++) {
      if (data[i][0] == rfid) {
        studentName = data[i][1];
        break;
      }
    }

    if (studentName == "") {
      response.status = "error";
      response.message = "Thẻ chưa đăng ký";
      return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
    }

    sheet2.appendRow([today, time, rfid, studentName, "Vào"]);
    response.status = "success";
    response.message = "Điểm danh thành công";
    return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);

  } else if (action == "checkout") {
    var rfid = e.parameter.rfid;
    var date = new Date();
    var time = Utilities.formatDate(date, Session.getScriptTimeZone(), "HH:mm:ss");
    var today = Utilities.formatDate(date, Session.getScriptTimeZone(), "yyyy-MM-dd");

    var studentName = "";
    var data = sheet1.getDataRange().getValues();
    for (var i = 1; i < data.length; i++) {
      if (data[i][0] == rfid) {
        studentName = data[i][1];
        break;
      }
    }

    if (studentName == "") {
      response.status = "error";
      response.message = "Thẻ chưa đăng ký";
      return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
    }

    sheet2.appendRow([today, time, rfid, studentName, "Ra"]);
    response.status = "success";
    response.message = "Điểm danh giờ ra thành công";
    return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
  }

  response.status = "error";
  response.message = "Hành động không hợp lệ";
  return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
}
